<!DOCTYPE HTML>
<html>
<head>
<meta name="viewport" content="width=device-width,minimum-scale=1.0,maximum-scale=1.0" />
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<title></title>
<link rel="stylesheet/less" type="text/css" href="ie10.less">
<script src="/h5/css/lib/less/less.js" type="text/javascript"></script>
<script>setTimeout("localStorage.clear();", 2000);</script></head>
<body>

<div class="demo">
    <ol class="marque">
        <li></li>
        <li></li>
        <li></li>
        <li></li>
        <li></li>
        <li></li>
        <li></li>
        <li></li>
        <li></li>
        <li></li>
        <li></li>
        <li></li>
        <li></li>
        <li></li>
        <li></li>
        <li></li>
        <li></li>
        <li></li>
        <li></li>
        <li></li>
        <li></li>
        <li></li>
        <li></li>
        <li></li>
        <li></li>
        <li></li>
        <li></li>
        <li></li>
    </ol>
    <div class="status"></div>
    <div class="btns">
        <a href="javascript:;" class="btn" onclick="m.move()">STEP</a>
        |
        <a href="javascript:;" class="btn" onclick="m.move(true)">AUTO</a>
        |
        <a href="javascript:;" class="btn" onclick="m.pause()">PAUSE</a>
    </div>
    <div class="debug"><textarea rows="8" style="display:block;width:99%;"></textarea></div>
</div>

<script src="/h5/js/src/commons/vendor.js"></script>
<script type="text/javascript">
    var hasPointerSupport = navigator.msPointerEnabled;
    var IE10Plus = /IE (1\d)/.exec(navigator.userAgent);
    var _EVT_DOWN = 'ontouchstart' in window ? 'touchstart' : hasPointerSupport ? 'MSPointerDown' : 'mousedown';
    var _EVT_MOVE = 'ontouchmove'  in window ? 'touchmove'  : hasPointerSupport ? 'MSPointerMove' : 'mousemove';
    var _EVT_UP   = 'ontouchend'   in window ? 'touchend'   : hasPointerSupport ? 'MSPointerUp'   : 'mouseup';
    var _EVT_TRANSITIONEND = ('ontransitionend' in window || IE10Plus) ? 'transitionend' : vendor.vendor + 'TransitionEnd';
    
    function _EVT_WRAP(e) {
        if (_EVT_DOWN == 'touchstart') {
            if (!e.touches[0]) return;
            e.x = e.touches[0].clientX;
            e.y = e.touches[0].clientY;
        }
        else {
            e.x = e.clientX;
            e.y = e.clientY;
        }
        return e;
    }

    var marque = function(args) {
        args = args || {};
        for (var o in args) {
            this[o] = args[o];
        }
        
        var _ = this;
        _.cellWidth = 100;
        _.step = 300;
        _.duration = 400;
        _.forward = true;  // ' -<--------'
        _.container = document.querySelector(_.container);
        _.el = document.querySelector(_.el);
        _.startX = _.lastX = _.curX = 0;
        
        _.el.style.width = _.el.children.length * _.cellWidth + 'px';
        _.width = _.el.clientWidth;
        
        _.transform(0);
        _.initTransition();
        
        _.bindSwipe();
        
        if (_.auto) {
            _.move(true);
        }
        else {
            _.pause();
        }

    };
    
    marque.prototype = {
        move: function(auto) {
            var _ = this;
            _.pause();
            _.status('RUNNING');
            if (_.forward) {
                _.curX -= _.step;  _.log('cur:  -<--------');
                if (_.curX <= -_.width + _.step) {
                    _.curX = -_.width + _.step
                    _.forward = !_.forward;  _.log('next:  ->');
                }
            }
            else {
                _.curX += _.step;  _.log('cur:  ->--------');
                if (_.curX >= 0) {
                    _.curX = 0;
                    _.forward = !_.forward;  _.log('next:  <-');
                }
            }
            
            _.transform(_.curX);
            _.lastX = _.curX;
            
            if (auto) {
                _.tick = setTimeout(function() { _.move(auto); }, 2000);
                setTimeout(function() { _.status('AUTO'); }, _.duration);
            }
            else {
                setTimeout(function() { _.pause(); }, _.duration);
            }
        },
        
        pause: function() {
            clearTimeout(this.tick);
            this.status('PAUSED');
        },
        
        bindSwipe: function() {
            var _ = this;
            function start(e) {
                e = _EVT_WRAP(e);
                _.pause();
                _.startX = e.x;
                _.lastX = _.curX;
                _.transition('');
                _.canDrag = true;
            }
            function drag(e) {
                if (!_.canDrag) return;
                window.getSelection ? window.getSelection().removeAllRanges() : document.selection.empty(); // 禁止拖放对象文本被选择的方法
                document.body.setCapture && _.el.setCapture(); // IE下鼠标超出视口仍可被监听
                e = _EVT_WRAP(e);
                e.preventDefault(); 
                _.curX = e.x - _.startX + _.lastX; 
                _.transform(_.curX);
            }
            function end(e) {
                if (!_.canDrag) return;
                if (_.forward && _.curX > _.lastX) {
                    _.forward = !_.forward;  _.log('next:  ->');
                }
                else if (!_.forward && _.curX < _.lastX) {
                    _.forward = !_.forward;  _.log('next:  <-');
                }
                
                _.curX = _.curX == 0 ? 0 : Math.floor(_.curX / _.cellWidth + (_.forward ? 1 : 0)) * _.cellWidth;
                _.initTransition();
                _.move(true);
                _.canDrag = false;
                return false;
            }
            
            _.el.addEventListener(_EVT_DOWN, start, 0);
            _.el.addEventListener(_EVT_MOVE, drag, 0);
            _.el.addEventListener(_EVT_UP, end, 0);
        },
        
        transform: function(x) {
            this.el.style[vendor.transform] = 'translate3D(' + x + 'px, 0, 0)';
        },
        
        transition: function(t) {
            this.el.style[vendor.transition] = t;
        },
        
        initTransition: function() {
            var _ = this;
            _.transition(vendor.cssVendor + 'transform ' + _.duration / 1000 + 's');
        },
        
        status: function(s) {
            this.container.querySelector('.status').innerHTML = s;
        },
        
        status: function(s) {
            this.container.querySelector('.status').innerHTML = s;
        },
        
        log: function(e) {
            if (this.debug) {
                var cmd = this.container.querySelector('.debug textarea');
                cmd.innerHTML += e + '\r\n';
                cmd.scrollTop = cmd.scrollHeight;
            }
        }
    
    };
    
    
    window.onload = function () {
        window.m = new marque({
            //auto: true,
            debug: true,
            container: '.demo',
            el: '.marque'
        });
    }

    
    
    
    




</script>
</body>
</html>