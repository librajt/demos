<!DOCTYPE html>
<html lang="en" ng-app='app'>
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="style/application.min.css">
    <style>
        body{background:#FFF;}
        hr{margin:0;border-top:1px solid #CCC;}
    </style>
    <title>Document</title>
</head>
<body ng-controller="appController">

<div class="form-horizontal" style="padding:20px;">
    <hr>
    forms:
    <hr>
    <authority-editor output="authority" authority-id="3">sss</authority-editor>
    <pre>{{authority|json}}</pre>

    <hr>
    forms:
    <hr>
    --

    <hr>
    forms:
    <hr>
</div>

<script src="http://tb1.bdstatic.com/tb/cms/com/mis/adsense/My97DatePicker/WdatePicker.js"></script>
<script src="js/angular.js"></script>
<script src="js/underscore.js"></script>
<script src="js/dirlist.js"></script>
<script src="js/relation.js"></script>
<script>
var appModule = angular.module('app', []);
appModule.controller('appController', function($scope) {
    $scope;
})

// -----------------------------------


// -----------------------------------
appModule.directive('authorityEditor', function() {

    function link(scope, elem, attr, ctrl) {
        scope.source = {};
        // scope.source.cover_all=elem.find('.coverAll').val();

        var defaultSettings = {
            'cover_all': 1,
            'virtual_dir': '',
            'first_dirs': '',
            'second_dirs': '',
            'forum_names': '',
            'black _names': '',
            'hot_dirs': '',
            'start_time': '',
            'end_time': ''
        }

        // use test data
        scope.dirList = window.dirList;

        // 初始化checkbox状态对象
        scope.dirListValue = {};
        _.each(scope.dirList, function(dirs) {
            scope.dirListValue[dirs.first_dir] = {
                second_dirs: {},
                hot_dirs: {}
            };
            _.each(dirs.second_dir, function(second_dir){
                scope.dirListValue[dirs.first_dir]['second_dirs'][second_dir] = {};
            });
            _.each(dirs.hot_dir, function(hot_dir){
                scope.dirListValue[dirs.first_dir]['hot_dirs'][hot_dir] = {};
            });
        });


        // 恢复dir选框状态，加载页面时用
        function restoreDirsValues(values) {
            if (values.first_dirs) {
                var _first_dirs = [];
                _.each(values.first_dirs.split(','), function(f_dir) {
                    if (scope.dirListValue[f_dir]) {
                        scope.dirListValue[f_dir].checked = true;
                        updateDirsAfterFirstDir(f_dir);
                    }
                    else {
                        _first_dirs.push(f_dir);
                    }
                });
                values.first_dirs = _first_dirs.join(',');
            }

            if (values.second_dirs) {
                var _second_dirs = [];
                _.each(values.second_dirs.split(','), function(s_dir) {
                    var _f_name = '';
                    _.each(scope.dirListValue, function(f_dir, f_name) {
                        if (scope.dirListValue[f_name]['second_dirs'][s_dir]) {
                            _f_name = f_name;
                        }
                    });
                    if (_f_name) {
                        scope.dirListValue[_f_name]['second_dirs'][s_dir].checked = true;
                    }
                    else {
                        _second_dirs.push(s_dir);
                    }
                });
                values.second_dirs = _second_dirs.join(',');
            }

            if (values.hot_dirs) {
                var _hot_dirs = [];
                _.each(values.hot_dirs.split(','), function(s_dir) {
                    var _f_name = '';
                    _.each(scope.dirListValue, function(f_dir, f_name) {
                        if (scope.dirListValue[f_name]['hot_dirs'][s_dir]) {
                            _f_name = f_name;
                        }
                    });
                    if (_f_name) {
                        scope.dirListValue[_f_name]['hot_dirs'][s_dir].checked = true;
                    }
                    else {
                        _hot_dirs.push(s_dir);
                    }
                });
                values.hot_dirs = _hot_dirs.join(',');
            }

            return values;
        }

        // 恢复页面元素值显示
        function restoreValues(values) {
            values = restoreDirsValues(values);

            scope.source.cover_all = values.cover_all;
            scope.source.virtual_dir = values.virtual_dir;
            scope.source.first_dirs = values.first_dirs;
            scope.source.second_dirs = values.second_dirs;
            scope.source.forum_names = values.forum_names;
            scope.source.black_names = values.black_names;
            scope.source.hot_dirs = values.hot_dirs;
            scope.source.start_time = values.start_time;
            scope.source.end_time = values.end_time;

            scope.datalist = {};
            scope.datalist.first_dirs = values.first_dirs;
            scope.datalist.second_dirs = values.second_dirs;
            scope.datalist.forum_names = values.forum_names;
            scope.datalist.black_names = values.black_names;
                
        }

        // 加载页面时取数据，填充页面展示
        function getVirtualDirs(cb) {
            // $http.get('/adsense/direction/getfirst').success(function(ret){
                var ret = {
                    data: [
                        '教育知心',
                        '医疗知心'
                    ]
                };
                cb && cb(ret);
            // });
        }

        // 加载页面时取数据，填充页面展示
        function getTopDirs(cb) {
            // $http.get('/adsense/direction/getfirst').success(function(ret){
                var ret = {
                    data: [
                        
                    ]
                };
                cb && cb(ret);
            // });
        }

        // 一级目录状态更新后，同步更新子目录状态
        function updateDirsAfterFirstDir(first_dir) {
            _.each(scope.dirListValue[first_dir]['second_dirs'], function (s_dir) {
                s_dir.checked = scope.dirListValue[first_dir].checked;
            });
            _.each(scope.dirListValue[first_dir]['hot_dirs'], function (s_dir) {
                s_dir.checked = scope.dirListValue[first_dir].checked;
            });
        }

        // 子目录状态更新后，同步更新父目录状态
        function updateDirsAfterSubDir(first_dir, sub_dir, sub_type) {
            if (scope.dirListValue[first_dir][sub_type][sub_dir].checked) {
                // 若为选中，检查所有子是否都为选中状态？是-选中父：否-啥也不做
                var checked = true;
                _.each(scope.dirListValue[first_dir]['second_dirs'], function(s_dir){
                    if (!s_dir.checked) checked = false;
                });
                _.each(scope.dirListValue[first_dir]['hot_dirs'], function(s_dir){
                    if (!s_dir.checked) checked = false;
                });
                scope.dirListValue[first_dir].checked = checked;
            }
            else {
                // 若不为选中，取消选中父
                scope.dirListValue[first_dir].checked = false;
            }
        }

        // 点击事件
        scope.onFirstDirsClick = function($event, first_dir) {
            updateDirsAfterFirstDir(first_dir);
        };

        scope.onSubDirsClick = function($event, first_dir, sub_dir, sub_type) {
            updateDirsAfterSubDir(first_dir, sub_dir, sub_type);
        };

        /*
            有无id？
                有-加载数据 http-get
                无-
                    加载虚拟目录 http-get
                    加载方向数据 http-get
                        设置值
         */

        if (attr.authorityId) {
            scope.authorityId = attr.authorityId;
            // $http.get('/adsense/direction/getfirst').success(function(ret){
                var ret = {
                    data: [
                    ]
                };

                defaultSettings.first_dirs = 'F2,FX';
                defaultSettings.second_dirs = 'F1_3,F1_2,FX_1';
                defaultSettings.hot_dirs = 'adsense_hotdir_b0dc2f50672971ce20ffc144c520476f_1';

                restoreValues(defaultSettings);

                getVirtualDirs(function(ret) {
                    scope.virtualDirs = ret.data;
                    scope.source.virtual_dir = ret.data[0];
                });

            // });
        }

        function formatPickerTime(s) {
            // s为yyyy/mm/dd hh:ii格式时间
            return +new Date(s.replace(/-/g,'/'));
        };

        // 提交时用
        function getCheckedDirs() {
            var ret = {
                first_dirs: [],
                second_dirs: [],
                hot_dirs: []
            };
            _.each(scope.dirListValue, function(first_dirs, f_name) {
                if (first_dirs.checked) ret.first_dirs.push(f_name);
                else {
                    _.each(first_dirs.second_dirs, function(sub_dir, s_name){
                        if (sub_dir.checked) ret.second_dirs.push(s_name);
                    });
                    _.each(first_dirs.hot_dirs, function(sub_dir, s_name){
                        if (sub_dir.checked) ret.hot_dirs.push(s_name);
                    });
                }
            });
            return ret;
        }


        /*
            提交：
                取复选框里的目录值，与文本框里的合并
                取各项的值
                    生成json，提交
         */
        scope.onSubmitClick = function() {
            
            // console.log(scope.dirListValue);
            // console.log(getDirsValues());

            var ret = {
                'cover_all': scope.source.cover_all,
                'virtual_dir': scope.source.virtual_dir,
                'first_dirs': scope.datalist.first_dirs,
                'second_dirs': scope.datalist.second_dirs,
                'forum_names': scope.datalist.forum_names,
                'black _names': scope.datalist.black_names,
                'hot_dirs': scope.source.hot_dirs,
                'start_time': scope.source.start_time,
                'end_time': scope.source.end_time
            };

            // 拼装选择的目录与输入的目录
            var selectedDirs = getCheckedDirs();
            ret.first_dirs += ret.first_dirs ? ',' : '';
            ret.first_dirs += selectedDirs.first_dirs ? selectedDirs.first_dirs.join(',') : '';
            ret.second_dirs += ret.second_dirs ? ',' : '';
            ret.second_dirs += selectedDirs.second_dirs ? selectedDirs.second_dirs.join(',') : '';
            ret.hot_dirs += ret.hot_dirs ? ',' : '';
            ret.hot_dirs += selectedDirs.hot_dirs ? selectedDirs.hot_dirs.join(',') : '';

            // 格式化时间
            ret.start_time = formatPickerTime(ret.start_time) / 1000;
            ret.end_time = formatPickerTime(ret.end_time) / 1000;

            scope.output = ret;
        }

    }

    return {
        restrict: 'EA',
        templateUrl: 't_authority.html',
        link: link,
        scope:{
            output:'='
        },
        replace: true
    };
});

// -----------------------------------


</script>

</body>
</html>